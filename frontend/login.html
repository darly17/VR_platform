<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR/AR Platform - Вход</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-vr-cardboard"></i>
                <h1>Вход в систему</h1>
                <p>Платформа разработки VR/AR сценариев</p>
            </div>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">
                        <i class="fas fa-user"></i> Имя пользователя или Email
                    </label>
                    <input type="text" id="username" placeholder="Введите имя пользователя или email" required>
                    <span class="error-message" id="usernameError"></span>
                </div>
                
                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i> Пароль
                    </label>
                    <input type="password" id="password" placeholder="Введите пароль" required>
                    <span class="error-message" id="passwordError"></span>
                </div>
                
                <button type="submit" id="loginBtn" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Войти
                </button>
            </form>
            
            <div class="quick-login">
                <h3>Быстрый вход</h3>
                <button class="quick-login-btn" data-role="admin">Администратор</button>
                <button class="quick-login-btn" data-role="developer">Разработчик</button>
                <button class="quick-login-btn" data-role="designer">Дизайнер</button>
                <button class="quick-login-btn" data-role="tester">Тестировщик</button>
            </div>
            
            <div class="login-footer">
                <a href="#" class="forgot-password">Забыли пароль?</a>
                <a href="#" class="register-link">Регистрация</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM загружен, инициализация скрипта логина...');  // Отладка: проверяем, запускается ли скрипт

            const form = document.getElementById('loginForm');
            const loginBtn = document.getElementById('loginBtn');
            if (!form || !loginBtn) {
                console.error('Форма или кнопка не найдены!');  // Отладка: если элементы отсутствуют
                return;
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;

                if (!username || !password) {
                    document.getElementById('usernameError').textContent = 'Заполните все поля';
                    return;
                }

                loginBtn.disabled = true;
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Вход...';

                try {
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        localStorage.setItem('token', data.access_token);
                        localStorage.setItem('user', JSON.stringify(data.user));
                        window.location.href = '/dashboard.html';  // Редирект после успеха
                    } else {
                        const errorMsg = data.detail || data.error || 'Неверный логин или пароль';
                        if (errorMsg.toLowerCase().includes('пароль')) {
                            document.getElementById('passwordError').textContent = errorMsg;
                        } else {
                            document.getElementById('usernameError').textContent = errorMsg;
                        }
                    }
                } catch (error) {
                    console.error('Ошибка сети:', error);
                    document.getElementById('usernameError').textContent = 'Нет соединения с сервером';
                } finally {
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Войти';
                }
            });

            form.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    form.dispatchEvent(new Event('submit'));
                }
            });

            // Обработчик для кнопок быстрого входа с отладкой
            const quickButtons = document.querySelectorAll('.quick-login-btn');
            console.log('Найдено кнопок быстрого входа:', quickButtons.length);  // Отладка: сколько кнопок найдено

            quickButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    console.log('Клик по кнопке, data-role:', btn.dataset.role);  // Отладка: клик сработал

                    const role = btn.dataset.role;
                    let username, password;
                    switch(role) {
                        case 'admin':
                            username = 'admin';
                            password = 'admin123';
                            break;
                        case 'developer':
                            username = 'developer';
                            password = 'dev123';
                            break;
                        case 'designer':
                            username = 'designer';
                            password = 'design123';
                            break;
                        case 'tester':
                            username = 'tester';
                            password = 'test123';
                            break;
                        default:
                            console.warn('Неизвестная роль:', role);  // Отладка: если роль не распознана
                    }
                    if (username && password) {
                        const usernameField = document.getElementById('username');
                        const passwordField = document.getElementById('password');
                        if (usernameField && passwordField) {
                            usernameField.value = username;
                            passwordField.value = password;
                            console.log('Поля заполнены:', username, password);  // Отладка: успех
                        } else {
                            console.error('Поля username или password не найдены!');  // Отладка: если поля не найдены
                        }
                    }
                });
            });

            console.log('Инициализация логин-страницы завершена');
        });
    </script>
</body>
</html>